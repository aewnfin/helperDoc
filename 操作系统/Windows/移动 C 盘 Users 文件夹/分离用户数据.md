# windows <small>分离系统文件和用户数据</small>
——将 Users 移动到目标文件夹，在系统盘建立符号链接。

用户数据-文件夹：
- C:\Users
    - AppData

> 从 Vista 以后，微软将用户文件和用户的软件配置 AppData 明确划分开，并且全部存放在使用者的用户目录下

程序数据-文件夹:
- ProgramData

> 在 XP 时代叫 Documents and Settings （记录和设置）

<div STYLE="page-break-after:always"><div>

## 方案一 <small>系统安装时使用</small>

1. 先划分好硬盘，在将要创建用户的时候按 <kbd>Shift</kbd> + <kbd>F10</kbd> 进入命令提示符
2. 复制 Users 文件夹到目标分区上
    ```
    robocopy C:\Users D:\Users /E /COPYALL /XJ
    ```
3. 移除系统盘原文件
    ```bat
    move C:\Users C:\Users2
    ```
4. 创建连接
    ```bat
    mklink /J C:\Users D:\Users
    ```
5. 继续进行系统安装，原文件夹可删
    ```bat
    rmdir C:\Users2 /S /Q
    ```

<div STYLE="page-break-after:always"><div>

## <span id="way1">方案二</span> <small>运行时使用</small>
1. 修改 `C:\Windows\System32\osk.exe` 文件名为 `osk1.exe` ，并使 `osk` 指向 `cmd` 。
    > `osk.exe` 文件的所有者为内置系统账户 `NT SERVICE\TrustedInstaller` ，需要修改文件所有者来获得 “修改权限”
    ```
    cd C:\Windows\System32\
    :: 使 osk 指向 cmd
    mklink osk.exe cmd.exe
    :: 如此，登录界面左下角的 “轻松使用” 中，“桌面键盘” 便被替换为 “命令行窗口”
    ```
2. 打开 “计算机管理” 启用 `Administrator` 账户，以 `Administrator` 账户登录，拷贝 `C:\Users` 到目标路径。
    ```bat
    :: 以管理员身份执行
    robocopy C:\Users D:\Users /E /COPYALL /XJ /XD C:\Users\Administrator
    ```
3. 注销账户，进入登录界面，打开 “命令行窗口” (详见：步骤 1 ) ，建立链接。
    ```bat
    move C:\Users C:\Users2
    mklink /J C:\Users D:\Users
    ```
4. 登录自己的管理员账户，收尾。
    ```bat
    :: 以管理员身份执行
    robocopy C:\Users2\Administrator C:\Users\Administrator /E /COPYALL /XJ
    rmdir C:\Users2 /S /Q
    :: 也可以手动删除
    ```
    > 1. 在 “控制面板” 》 “轻松访问中心” 》 “使用没有鼠标或键盘的计算机” 中：
    >   - 取消勾选 “使用屏幕键盘” ，防止每次开机都默认打开 “命令行窗口”

<div STYLE="page-break-after:always"><div>

> **SP**
> 
> 可以将 **目标路径** 替换为 **卷访问路径** ：
> 1. 计算机管理 》存储 》磁盘管理 -> 选择：某一本地卷：右键 -> “更改驱动器号和路径”
> 2. 添加路径 `C:\space` ，使用户可以通过此路径访问该卷。
> 3. 卷访问路径 `C:\space` 可以替代 [方案二](#way1) 中的 `D:\Users` 成为 `robocopy` 的目标路径
> 4. 在登录界面执行以下命令，完成用户数据的重定向：
>    ```bat
>    move C:\Users C:\Users2
>    move C:\space C:\Users
>    ```

---
2020 / 04 / 22