---
toc:
    depth_from: 2
---

# Windows <small><small>将用户配置从系统卷分离</small></small>
[TOC]
## 背景
&emsp;Windows 的用户文件夹默认所在位置是系统盘（通常是C盘）下的 “\Users” 目录之内。
该文件夹中保存着所有的用户个人数据，包括“桌面”、“我的文档” 等等。

&emsp;用户文件夹处于系统盘的坏处在于，如若系统盘一旦坏掉，就可能连带用户文件一并丢失；其次，由于用户文件处于系统盘，也没办法时常备份“干净的系统盘”；第三，用户文件夹的文件越来越多可能会导致系统盘容量不足。

&emsp;如果能把用户文件夹挪到另外一块硬盘上（或者另外一个硬盘分区上），那么系统维护就会容易得多。平时生成的文件（大多数人放在“桌面”、“我的文档”里的文件最多），都被保存在系统盘（或分区）之外；于是随时都可以在不必担心用户文件丢失的情况下重新安装系统（或恢复系统备份）

## 方案
1. 复制 “\Users” 文件夹到另外一块硬盘上（或者另外一个硬盘分区上）
2. 移除原先的 “\Users” 文件夹
3. 使系统盘（通常是C盘）下路径 “\Users” 指向另外一块硬盘（或者另外一个硬盘分区）

## 准备工作
### 不需要用户登录就可以使用的命令行窗口
1. 找到路径 `C:\Windows\System32\` 下的桌面键盘程序 `osk.exe`

    ![搜索osk](img\搜索osk.png)
2. 右键 `osk.exe` 选择 “属性” 》选择 “安全” 标签页

    ![osk属性](img\osk属性.png)
3. 点击按钮 “高级” ，当前文件所有者为 `TrustedInstaller`

    ![osk所有者](img\osk所有者.png)
4. 点击按钮 “编辑(E)...” 更改文件所有者为 `Administrators`

    ![osk所有者2](img\osk所有者2.png)
5. 设置 `Administrators` 权限为 “完全控制”
    
    ![osk权限](img\osk权限.png)
6. 以管理员身份重命名 `osk.exe`

    ![重命名osk](img\重命名osk.png)
7. 以管理员身份执行以下命令
    ```bat
    mklink C:\Windows\System32\osk.exe C:\Windows\System32\cmd.exe
    ```
    ![osk软链接](img\osk软链接.png)

### 移动用户配置文件的额外管理员账户
1. 打开 “计算机管理”，选择 “系统工具” 》“本地用户和组” 》“用户”

    ![计算机管理](img\计算机管理.png)
2. 右键用户 “Administrator” 选择 “属性”

    ![Administrator属性](img\Administrator属性.png)
3. 取消勾选 “账户已禁用(B)”

    ![Administrator属性2](img\Administrator属性2.png)
4. 点击按钮 “确定”

    ![计算机管理2](img\计算机管理2.png)

### 隐藏另外一块硬盘（或者另外一个硬盘分区）
1. 打开 “计算机管理”，选择 “存储” 》“磁盘管理”

    ![磁盘管理](img\磁盘管理.png)
2. 右键卷 “(D:)” 选择 “更改驱动器号和路径(C)...”

    ![驱动器号和路径](img\驱动器号和路径.png)
3. 新建文件夹 `C:\New`
4. 点击按钮 “添加(D)...” 输入 `C:\New`

    ![添加路径](img\添加路径.png)
5. 点击按钮 “确定”

    ![驱动器号和路径2](img\驱动器号和路径2.png)
6. 选择驱动器号 “D:”，点击按钮 “删除(R)”

    ![警告](img\警告.png)
7. 点击 “是”

    ![磁盘管理2](img\磁盘管理2.png)


## 执行操作
1. 注销当前账户
2. 登录 `Administrator` 账户
3. 以管理员身份执行拷贝命令
    ```bat
    robocopy C:\Users C:\New /E /COPYALL /XJ /XD C:\Users\Administrator
    ```
4. 注销 `Administrator` 账户
5. 在登录界面点击 “轻松访问”，勾选 “(不使用键盘输入)屏幕键盘”
6. 点击 “确定”

    ![cmd](img\cmd.png)
7. 执行命令重命名卷
    ```bat
    move C:\Users C:\Users2
    move C:\New C:\Users
    ```
> <big>也许有用的命令</big>
> - `explorer` 打开 “资源管理器” 命令
> - `taskmgr` 打开 “任务管理器” 命令

## 扫尾
### 转移 `Administrator` 账户
1. 登录其他拥有 `管理员` 权限的账户
2. 以管理员身份执行拷贝命令
    ```bat
    robocopy C:\Users2\Administrator C:\Users\Administrator /E /COPYALL /XJ
    ```
### 禁用 `Administrator` 账户
1. 打开 “计算机管理”，选择 “系统工具” 》“本地用户和组” 》“用户”
2. 在 “Administrator” 用户 “属性” 中勾选 “账户已禁用(B)”
3. 点击按钮 “确定”

### 还原 `osk.exe` 权限
1. 删除软连接 `C:\Windows\System32\osk.exe`
2. 以管理员身份重命名 `osk1.exe` 为 `osk.exe`
3. 取消之前赋予 `Administrators` 的权限
4. 手动输入 `NT SERVICE\TrustedInstaller` 更改 `osk.exe` 文件所有者 

### 取消 “帮助中心” 开机设置
1. 打开 “轻松访问中心”

    ![轻松访问中心](img\轻松访问中心.png)
2. 点击 “使用没有鼠标或键盘的计算机”

    ![使用没有鼠标或键盘的计算机](img\使用没有鼠标或键盘的计算机.png)
3. 取消勾选 “使用屏幕键盘(K)”

    ![使用没有鼠标或键盘的计算机2](img\使用没有鼠标或键盘的计算机2.png)
4. 点击 “确定(O)”